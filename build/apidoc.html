<div class="apidocDiv">
<style>
/*csslint
*/
.apidocDiv {
    background: #fff;
    font-family: Arial, Helvetica, sans-serif;
}
.apidocDiv a[href] {
    color: #33f;
    font-weight: bold;
    text-decoration: none;
}
.apidocDiv a[href]:hover {
    text-decoration: underline;
}
.apidocCodeCommentSpan {
    background: #bbf;
    color: #000;
    display: block;
}
.apidocCodeKeywordSpan {
    color: #d00;
    font-weight: bold;
}
.apidocCodePre {
    background: #eef;
    border: 1px solid;
    color: #777;
    padding: 5px;
    white-space: pre-wrap;
}
.apidocFooterDiv {
    margin-top: 20px;
    text-align: center;
}
.apidocModuleLi {
    margin-top: 10px;
}
.apidocSectionDiv {
    border-top: 1px solid;
    margin-top: 20px;
}
.apidocSignatureSpan {
    color: #777;
    font-weight: bold;
}
</style>
<h1>api documentation for
    <a

        href="https://github.com/mateodelnorte/sourced-repo-mongo"

    >sourced-repo-mongo (v0.3.12)</a>
</h1>
<h4>mongo data store and repository for sourced-style event sourcing models</h4>
<div class="apidocSectionDiv"><a
    href="#apidoc.tableOfContents"
    id="apidoc.tableOfContents"
><h1>table of contents</h1></a><ol>

    <li class="apidocModuleLi"><a href="#apidoc.module.sourced-repo-mongo">module sourced-repo-mongo</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.sourced-repo-mongo.Repository">
            function <span class="apidocSignatureSpan">sourced-repo-mongo.</span>Repository
            <span class="apidocSignatureSpan">(entityType, options)</span>
            </a>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">sourced-repo-mongo.</span>Repository.prototype</span>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.sourced-repo-mongo.Repository">module sourced-repo-mongo.Repository</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.sourced-repo-mongo.Repository.Repository">
            function <span class="apidocSignatureSpan">sourced-repo-mongo.</span>Repository
            <span class="apidocSignatureSpan">(entityType, options)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.sourced-repo-mongo.Repository.super_">
            function <span class="apidocSignatureSpan">sourced-repo-mongo.Repository.</span>super_
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.sourced-repo-mongo.Repository.prototype">module sourced-repo-mongo.Repository.prototype</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.sourced-repo-mongo.Repository.prototype._commitAllEvents">
            function <span class="apidocSignatureSpan">sourced-repo-mongo.Repository.prototype.</span>_commitAllEvents
            <span class="apidocSignatureSpan">(entities, cb)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.sourced-repo-mongo.Repository.prototype._commitAllSnapshots">
            function <span class="apidocSignatureSpan">sourced-repo-mongo.Repository.prototype.</span>_commitAllSnapshots
            <span class="apidocSignatureSpan">(entities, options, cb)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.sourced-repo-mongo.Repository.prototype._commitEvents">
            function <span class="apidocSignatureSpan">sourced-repo-mongo.Repository.prototype.</span>_commitEvents
            <span class="apidocSignatureSpan">(entity, cb)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.sourced-repo-mongo.Repository.prototype._commitSnapshots">
            function <span class="apidocSignatureSpan">sourced-repo-mongo.Repository.prototype.</span>_commitSnapshots
            <span class="apidocSignatureSpan">(entity, options, cb)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.sourced-repo-mongo.Repository.prototype._deserialize">
            function <span class="apidocSignatureSpan">sourced-repo-mongo.Repository.prototype.</span>_deserialize
            <span class="apidocSignatureSpan">(id, snapshot, events)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.sourced-repo-mongo.Repository.prototype._emitEvents">
            function <span class="apidocSignatureSpan">sourced-repo-mongo.Repository.prototype.</span>_emitEvents
            <span class="apidocSignatureSpan">(entity)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.sourced-repo-mongo.Repository.prototype._getAllEvents">
            function <span class="apidocSignatureSpan">sourced-repo-mongo.Repository.prototype.</span>_getAllEvents
            <span class="apidocSignatureSpan">(ids, snapshots, cb)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.sourced-repo-mongo.Repository.prototype._getAllSnapshots">
            function <span class="apidocSignatureSpan">sourced-repo-mongo.Repository.prototype.</span>_getAllSnapshots
            <span class="apidocSignatureSpan">(ids, cb)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.sourced-repo-mongo.Repository.prototype._getByIndex">
            function <span class="apidocSignatureSpan">sourced-repo-mongo.Repository.prototype.</span>_getByIndex
            <span class="apidocSignatureSpan">(index, value, cb)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.sourced-repo-mongo.Repository.prototype.commit">
            function <span class="apidocSignatureSpan">sourced-repo-mongo.Repository.prototype.</span>commit
            <span class="apidocSignatureSpan">(entity, options, cb)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.sourced-repo-mongo.Repository.prototype.commitAll">
            function <span class="apidocSignatureSpan">sourced-repo-mongo.Repository.prototype.</span>commitAll
            <span class="apidocSignatureSpan">(entities, options, cb)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.sourced-repo-mongo.Repository.prototype.get">
            function <span class="apidocSignatureSpan">sourced-repo-mongo.Repository.prototype.</span>get
            <span class="apidocSignatureSpan">(id, cb)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.sourced-repo-mongo.Repository.prototype.getAll">
            function <span class="apidocSignatureSpan">sourced-repo-mongo.Repository.prototype.</span>getAll
            <span class="apidocSignatureSpan">(ids, cb)</span>
            </a>

        </li>

    </ol></li>

</ol></div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.sourced-repo-mongo" id="apidoc.module.sourced-repo-mongo">module sourced-repo-mongo</a></h1>


    <h2>
        <a href="#apidoc.element.sourced-repo-mongo.Repository" id="apidoc.element.sourced-repo-mongo.Repository">
        function <span class="apidocSignatureSpan">sourced-repo-mongo.</span>Repository
        <span class="apidocSignatureSpan">(entityType, options)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function Repository(entityType, options) {
  options = options || {};
  EventEmitter.call(this);
  if ( ! mongo.db) {
    throw new Error(&#x27;mongo has not been initialized. you must call require(\&#x27;sourced-repo-mongo/mongo\&#x27;).connect(config.MONGO_URL
); before instantiating a Repository&#x27;);
  }
  var indices = _.union(options.indices, [&#x27;id&#x27;]);
  var self = this;
  var db = mongo.db;
  self.entityType = entityType;
  self.indices = indices;
  self.snapshotFrequency = options.snapshotFrequency || 10;

  var snapshotCollectionName = util.format(&#x27;%s.snapshots&#x27;, entityType.name);
  var snapshots = db.collection(snapshotCollectionName);
  self.snapshots = snapshots;
  var eventCollectionName = util.format(&#x27;%s.events&#x27;, entityType.name);
  var events = db.collection(eventCollectionName);
  self.events = events;

  var error = function (err) {
    if (err) return self.emit(&#x27;error&#x27;, err);
  };

  self.indices.forEach(function (index) {
    snapshots.ensureIndex(index, error);
    events.ensureIndex(index, error);
  });
  events.ensureIndex({ id: 1, version: 1 }, error);
  snapshots.ensureIndex({ id: 1, version: 1 }, error);
  snapshots.ensureIndex(&#x27;snapshotVersion&#x27;, error);

  log(&#x27;initialized %s entity store&#x27;, self.entityType.name);

  self.emit(&#x27;ready&#x27;);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>




</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.sourced-repo-mongo.Repository" id="apidoc.module.sourced-repo-mongo.Repository">module sourced-repo-mongo.Repository</a></h1>


    <h2>
        <a href="#apidoc.element.sourced-repo-mongo.Repository.Repository" id="apidoc.element.sourced-repo-mongo.Repository.Repository">
        function <span class="apidocSignatureSpan">sourced-repo-mongo.</span>Repository
        <span class="apidocSignatureSpan">(entityType, options)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function Repository(entityType, options) {
  options = options || {};
  EventEmitter.call(this);
  if ( ! mongo.db) {
    throw new Error(&#x27;mongo has not been initialized. you must call require(\&#x27;sourced-repo-mongo/mongo\&#x27;).connect(config.MONGO_URL
); before instantiating a Repository&#x27;);
  }
  var indices = _.union(options.indices, [&#x27;id&#x27;]);
  var self = this;
  var db = mongo.db;
  self.entityType = entityType;
  self.indices = indices;
  self.snapshotFrequency = options.snapshotFrequency || 10;

  var snapshotCollectionName = util.format(&#x27;%s.snapshots&#x27;, entityType.name);
  var snapshots = db.collection(snapshotCollectionName);
  self.snapshots = snapshots;
  var eventCollectionName = util.format(&#x27;%s.events&#x27;, entityType.name);
  var events = db.collection(eventCollectionName);
  self.events = events;

  var error = function (err) {
    if (err) return self.emit(&#x27;error&#x27;, err);
  };

  self.indices.forEach(function (index) {
    snapshots.ensureIndex(index, error);
    events.ensureIndex(index, error);
  });
  events.ensureIndex({ id: 1, version: 1 }, error);
  snapshots.ensureIndex({ id: 1, version: 1 }, error);
  snapshots.ensureIndex(&#x27;snapshotVersion&#x27;, error);

  log(&#x27;initialized %s entity store&#x27;, self.entityType.name);

  self.emit(&#x27;ready&#x27;);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.sourced-repo-mongo.Repository.super_" id="apidoc.element.sourced-repo-mongo.Repository.super_">
        function <span class="apidocSignatureSpan">sourced-repo-mongo.Repository.</span>super_
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function EventEmitter() {
  EventEmitter.init.call(this);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.sourced-repo-mongo.Repository.prototype" id="apidoc.module.sourced-repo-mongo.Repository.prototype">module sourced-repo-mongo.Repository.prototype</a></h1>


    <h2>
        <a href="#apidoc.element.sourced-repo-mongo.Repository.prototype._commitAllEvents" id="apidoc.element.sourced-repo-mongo.Repository.prototype._commitAllEvents">
        function <span class="apidocSignatureSpan">sourced-repo-mongo.Repository.prototype.</span>_commitAllEvents
        <span class="apidocSignatureSpan">(entities, cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function _commitEvents(entities, cb) {
  var self = this;

  var events = [];
  entities.forEach(function (entity) {
    if (entity.newEvents.length === 0) return;

    if ( ! entity.id) return cb(new Error(&#x27;Cannot commit an entity of type [%s] without an [id] property&#x27;, self.entityType));

    var evnts = entity.newEvents;
    evnts.forEach(function _applyIndices (event) {
      if (event &#x26;&#x26; event._id) delete event._id; // mongo will blow up if we try to insert multiple _id keys
      self.indices.forEach(function (index) {
        event[index] = entity[index];
      });
    });
    Array.prototype.unshift.apply(events, evnts);
  });

  if (events.length === 0) return cb();

  self.events.insert(events, function (err) {
    if (err) return cb(err);
    log(&#x27;committed %s.events for ids %j&#x27;, self.entityType.name, _.pluck(entities, &#x27;id&#x27;));
    entities.forEach(function (entity) {
      entity.newEvents = [];
    });
    return cb();
  });

}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
  options = {};
}

var self = this;

log(&#x27;committing %s for id %j&#x27;, this.entityType.name, _.pluck(entities, &#x27;id&#x27;));

this.<span class="apidocCodeKeywordSpan">_commitAllEvents</span>(entities, function _afterCommitEvents (err) {
  if (err) return cb(err);
  self._commitAllSnapshots(entities, options, function _afterCommitSnapshots (err) {
    if (err) return cb(err);
    entities.forEach(function (entity) {
      self._emitEvents(entity);
    });
    return cb();
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.sourced-repo-mongo.Repository.prototype._commitAllSnapshots" id="apidoc.element.sourced-repo-mongo.Repository.prototype._commitAllSnapshots">
        function <span class="apidocSignatureSpan">sourced-repo-mongo.Repository.prototype.</span>_commitAllSnapshots
        <span class="apidocSignatureSpan">(entities, options, cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function _commitAllSnapshots(entities, options, cb) {
  var self = this;

  var snapshots = [];
  entities.forEach(function (entity) {
    if (options.forceSnapshot || entity.version &#x3e;= entity.snapshotVersion + self.snapshotFrequency) {
      var snapshot = entity.snapshot();
      if (snapshot) {
        if (snapshot._id) delete snapshot._id; // mongo will blow up if we try to insert multiple _id keys)
        snapshots.push(snapshot);
      }
    }
  });

  if (snapshots.length === 0) return cb();

  self.snapshots.insert(snapshots, function (err) {
    if (err) return cb(err);
    log(&#x27;committed %s.snapshot for ids %s %j&#x27;, self.entityType.name, _.pluck(entities, &#x27;id&#x27;), snapshots);
    return cb(null, entities);
  });

}</pre></li>
    <li>example usage<pre class="apidocCodePre">...

var self = this;

log(&#x27;committing %s for id %j&#x27;, this.entityType.name, _.pluck(entities, &#x27;id&#x27;));

this._commitAllEvents(entities, function _afterCommitEvents (err) {
  if (err) return cb(err);
  self.<span class="apidocCodeKeywordSpan">_commitAllSnapshots</span>(entities, options, function _afterCommitSnapshots (err) {
    if (err) return cb(err);
    entities.forEach(function (entity) {
      self._emitEvents(entity);
    });
    return cb();
  });
});
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.sourced-repo-mongo.Repository.prototype._commitEvents" id="apidoc.element.sourced-repo-mongo.Repository.prototype._commitEvents">
        function <span class="apidocSignatureSpan">sourced-repo-mongo.Repository.prototype.</span>_commitEvents
        <span class="apidocSignatureSpan">(entity, cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function _commitEvents(entity, cb) {
  var self = this;

  if (entity.newEvents.length === 0) return cb();

  if ( ! entity.id) return cb(new Error(&#x27;Cannot commit an entity of type [%s] without an [id] property&#x27;, this.entityType));

  var events = entity.newEvents;
  events.forEach(function _applyIndices (event) {
    if (event &#x26;&#x26; event._id) delete event._id; // mongo will blow up if we try to insert multiple _id keys
    self.indices.forEach(function (index) {
      event[index] = entity[index];
    });
  });
  self.events.insert(events, function (err) {
    if (err) return cb(err);
    log(&#x27;committed %s.events for id %s&#x27;, self.entityType.name, entity.id);
    entity.newEvents = [];
    return cb();
  });

}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
options = {};
  }

  var self = this;

  log(&#x27;committing %s for id %s&#x27;, this.entityType.name, entity.id);

  this.<span class="apidocCodeKeywordSpan">_commitEvents</span>(entity, function _afterCommitEvents (err) {
if (err) return cb(err);

self._commitSnapshots(entity, options, function _afterCommitSnapshots (err) {
  if (err) return cb(err);
  self._emitEvents(entity);
  return cb();
});
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.sourced-repo-mongo.Repository.prototype._commitSnapshots" id="apidoc.element.sourced-repo-mongo.Repository.prototype._commitSnapshots">
        function <span class="apidocSignatureSpan">sourced-repo-mongo.Repository.prototype.</span>_commitSnapshots
        <span class="apidocSignatureSpan">(entity, options, cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function _commitSnapshots(entity, options, cb) {
  var self = this;

  if (options.forceSnapshot || entity.version &#x3e;= entity.snapshotVersion + self.snapshotFrequency) {
    var snapshot = entity.snapshot();
    if (snapshot &#x26;&#x26; snapshot._id) delete snapshot._id; // mongo will blow up if we try to insert multiple _id keys
    self.snapshots.insert(snapshot, function (err) {
      if (err) return cb(err);
      log(&#x27;committed %s.snapshot for id %s %j&#x27;, self.entityType.name, entity.id, snapshot);
      return cb(null, entity);
    });
  } else {
    return cb(null, entity);
  }

}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
  var self = this;

  log(&#x27;committing %s for id %s&#x27;, this.entityType.name, entity.id);

  this._commitEvents(entity, function _afterCommitEvents (err) {
    if (err) return cb(err);

    self.<span class="apidocCodeKeywordSpan">_commitSnapshots</span>(entity, options, function _afterCommitSnapshots (err) {
      if (err) return cb(err);
      self._emitEvents(entity);
      return cb();
    });
  });

};
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.sourced-repo-mongo.Repository.prototype._deserialize" id="apidoc.element.sourced-repo-mongo.Repository.prototype._deserialize">
        function <span class="apidocSignatureSpan">sourced-repo-mongo.Repository.prototype.</span>_deserialize
        <span class="apidocSignatureSpan">(id, snapshot, events)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function _deserialize(id, snapshot, events) {
  log(&#x27;deserializing %s entity &#x27;, this.entityType.name);
  var entity = new this.entityType(snapshot, events);
  entity.id = id;
  return entity;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
      .toArray(function (err, events) {
        if (err) return cb(err);
        if (snapshot) delete snapshot._id;
        if ( ! snapshot &#x26;&#x26; ! events.length) return cb(null, null);

        var id = (index === &#x27;id&#x27;) ? value : (snapshot) ? snapshot.id : events[0].id;

        var entity = self.<span class="apidocCodeKeywordSpan">_deserialize</span>(id, snapshot, events);
        return cb(null, entity);
      });
});
};

Repository.prototype.getAll = function getAll (ids, cb) {
var self = this;
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.sourced-repo-mongo.Repository.prototype._emitEvents" id="apidoc.element.sourced-repo-mongo.Repository.prototype._emitEvents">
        function <span class="apidocSignatureSpan">sourced-repo-mongo.Repository.prototype.</span>_emitEvents
        <span class="apidocSignatureSpan">(entity)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function _emitEvents(entity) {
  var self = this;

  var eventsToEmit = entity.eventsToEmit;
  entity.eventsToEmit = [];
  eventsToEmit.forEach(function (eventToEmit) {
    var args = Array.prototype.slice.call(eventToEmit);
    self.entityType.prototype.emit.apply(entity, args);
  });

  log(&#x27;emitted local events for id %s&#x27;, entity.id);

}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
  log(&#x27;committing %s for id %s&#x27;, this.entityType.name, entity.id);

  this._commitEvents(entity, function _afterCommitEvents (err) {
    if (err) return cb(err);

    self._commitSnapshots(entity, options, function _afterCommitSnapshots (err) {
      if (err) return cb(err);
      self.<span class="apidocCodeKeywordSpan">_emitEvents</span>(entity);
      return cb();
    });
  });

};

Repository.prototype.commitAll = function commit (entities, options, cb) {
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.sourced-repo-mongo.Repository.prototype._getAllEvents" id="apidoc.element.sourced-repo-mongo.Repository.prototype._getAllEvents">
        function <span class="apidocSignatureSpan">sourced-repo-mongo.Repository.prototype.</span>_getAllEvents
        <span class="apidocSignatureSpan">(ids, snapshots, cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function _getAllEvents(ids, snapshots, cb) {
  var self = this;

  var criteria = { $or: [] };
  ids.forEach(function (id) {
    var snapshot;
    if ( ! (snapshot = _.find(snapshots, function (snapshot) {
      return id === snapshot.id;
    }))) {
      criteria.$or.push({ id: id });
    } else {
      criteria.$or.push({ id: snapshot.id, version: { $gt: snapshot.snapshotVersion } });
    }
  });

  self.events.find(criteria)
    .sort({ id: 1, version: 1 })
    .toArray(function (err, events) {
      if (err) return cb(err);
      if ( ! snapshots.length &#x26;&#x26; ! events.length) return cb(null, null);
      var results = [];
      ids.forEach(function (id) {
        var snapshot = _.find(snapshots, function (snapshot) {
          return snapshot.id === id;
        });
        if (snapshot) delete snapshot._id;
        var evnts = _.filter(events, function (event) {
          return event.id === id;
        });
        var entity = self._deserialize(id, snapshot, evnts);
        results.push(entity);
      });
      return cb(null, results);
    });

}</pre></li>
    <li>example usage<pre class="apidocCodePre">...

  log(&#x27;getting %ss for ids %j&#x27;, this.entityType.name, ids);

  if (ids.length === 0) return cb(null, []);

  this._getAllSnapshots(ids, function _afterGetAllSnapshots (err, snapshots) {
    if (err) return cb(err);
    self.<span class="apidocCodeKeywordSpan">_getAllEvents</span>(ids, snapshots, function (err, entities) {
      if (err) return cb(err);
      return cb(null, entities);
    });
  });
};

Repository.prototype._commitEvents = function _commitEvents (entity, cb) {
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.sourced-repo-mongo.Repository.prototype._getAllSnapshots" id="apidoc.element.sourced-repo-mongo.Repository.prototype._getAllSnapshots">
        function <span class="apidocSignatureSpan">sourced-repo-mongo.Repository.prototype.</span>_getAllSnapshots
        <span class="apidocSignatureSpan">(ids, cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function _getAllSnapshots(ids, cb) {
  var self = this;

  var match = { $match: { id: { $in: ids } } };
  var sort = { $sort: { snapshotVersion: 1 } };
  var group = { $group: { _id: &#x27;$id&#x27;, snapshotVersion: { $last: &#x27;$snapshotVersion&#x27; } } };

  self.snapshots.aggregate([match, sort, group], function (err, idVersionPairs) {
    if (err) return cb(err);
    var criteria = {};
    if (idVersionPairs.length === 0) {
      return cb(null, []);
    } else if (idVersionPairs.length === 1) {
      criteria = { id: idVersionPairs[0]._id, snapshotVersion: idVersionPairs[0].snapshotVersion };
    } else {
      criteria.$or = [];
      idVersionPairs.forEach(function (pair) {
        var cri = { id: pair._id, snapshotVersion: pair.snapshotVersion };
        criteria.$or.push(cri);
      });
    }
    self.snapshots
      .find(criteria)
      .toArray(function (err, snapshots) {
        if (err) cb(err);
        return cb(null, snapshots);
      });
  });

}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
    });
  }

  log(&#x27;getting %ss for ids %j&#x27;, this.entityType.name, ids);

  if (ids.length === 0) return cb(null, []);

  this.<span class="apidocCodeKeywordSpan">_getAllSnapshots</span>(ids, function _afterGetAllSnapshots (err, snapshots) {
    if (err) return cb(err);
    self._getAllEvents(ids, snapshots, function (err, entities) {
      if (err) return cb(err);
      return cb(null, entities);
    });
  });
};
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.sourced-repo-mongo.Repository.prototype._getByIndex" id="apidoc.element.sourced-repo-mongo.Repository.prototype._getByIndex">
        function <span class="apidocSignatureSpan">sourced-repo-mongo.Repository.prototype.</span>_getByIndex
        <span class="apidocSignatureSpan">(index, value, cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function _getByIndex(index, value, cb) {
  var self = this;

  if (this.indices.indexOf(index) === -1) throw new Error(&#x27;Cannot get sourced entity type [%s] by index [%s]&#x27;, this.entityType,
index);

  log(&#x27;getting %s for %s %s&#x27;, this.entityType.name, index, value);

  var criteria = { };
  criteria[index] = value;

  this.snapshots
    .find(criteria)
    .sort({ version: -1 })
    .limit(-1)
    .toArray(function (err, snapshots) {
      if (err) return cb(err);

      var snapshot = snapshots[0];

      if (snapshot) criteria.version = { $gt: snapshot.version };
      self.events.find(criteria)
        .sort({ version: 1 })
        .toArray(function (err, events) {
          if (err) return cb(err);
          if (snapshot) delete snapshot._id;
          if ( ! snapshot &#x26;&#x26; ! events.length) return cb(null, null);

          var id = (index === &#x27;id&#x27;) ? value : (snapshot) ? snapshot.id : events[0].id;

          var entity = self._deserialize(id, snapshot, events);
          return cb(null, entity);
        });
  });
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
    return cb();
  });
});

};

Repository.prototype.get = function get (id, cb) {
return this.<span class="apidocCodeKeywordSpan">_getByIndex</span>(&#x27;id&#x27;, id, cb);
};

Repository.prototype._getByIndex = function _getByIndex (index, value, cb) {
var self = this;

if (this.indices.indexOf(index) === -1) throw new Error(&#x27;Cannot get sourced entity type [%s] by index [%s]&#x27;, this.entityType
, index);
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.sourced-repo-mongo.Repository.prototype.commit" id="apidoc.element.sourced-repo-mongo.Repository.prototype.commit">
        function <span class="apidocSignatureSpan">sourced-repo-mongo.Repository.prototype.</span>commit
        <span class="apidocSignatureSpan">(entity, options, cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function commit(entity, options, cb) {
  if (typeof options === &#x27;function&#x27;) {
    cb = options;
    options = {};
  }

  var self = this;

  log(&#x27;committing %s for id %s&#x27;, this.entityType.name, entity.id);

  this._commitEvents(entity, function _afterCommitEvents (err) {
    if (err) return cb(err);

    self._commitSnapshots(entity, options, function _afterCommitSnapshots (err) {
      if (err) return cb(err);
      self._emitEvents(entity);
      return cb();
    });
  });

}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.sourced-repo-mongo.Repository.prototype.commitAll" id="apidoc.element.sourced-repo-mongo.Repository.prototype.commitAll">
        function <span class="apidocSignatureSpan">sourced-repo-mongo.Repository.prototype.</span>commitAll
        <span class="apidocSignatureSpan">(entities, options, cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function commit(entities, options, cb) {
  if (typeof options === &#x27;function&#x27;) {
    cb = options;
    options = {};
  }

  var self = this;

  log(&#x27;committing %s for id %j&#x27;, this.entityType.name, _.pluck(entities, &#x27;id&#x27;));

  this._commitAllEvents(entities, function _afterCommitEvents (err) {
    if (err) return cb(err);
    self._commitAllSnapshots(entities, options, function _afterCommitSnapshots (err) {
      if (err) return cb(err);
      entities.forEach(function (entity) {
        self._emitEvents(entity);
      });
      return cb();
    });
  });

}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.sourced-repo-mongo.Repository.prototype.get" id="apidoc.element.sourced-repo-mongo.Repository.prototype.get">
        function <span class="apidocSignatureSpan">sourced-repo-mongo.Repository.prototype.</span>get
        <span class="apidocSignatureSpan">(id, cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function get(id, cb) {
  return this._getByIndex(&#x27;id&#x27;, id, cb);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.sourced-repo-mongo.Repository.prototype.getAll" id="apidoc.element.sourced-repo-mongo.Repository.prototype.getAll">
        function <span class="apidocSignatureSpan">sourced-repo-mongo.Repository.prototype.</span>getAll
        <span class="apidocSignatureSpan">(ids, cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function getAll(ids, cb) {
  var self = this;

  if (typeof ids === &#x27;function&#x27;) {
    cb = ids;
    ids = null;
    return this.events.distinct(&#x27;id&#x27;, function (err, distinctEventIds) {
      self.getAll(distinctEventIds, cb);
    });
  }

  log(&#x27;getting %ss for ids %j&#x27;, this.entityType.name, ids);

  if (ids.length === 0) return cb(null, []);

  this._getAllSnapshots(ids, function _afterGetAllSnapshots (err, snapshots) {
    if (err) return cb(err);
    self._getAllEvents(ids, snapshots, function (err, entities) {
      if (err) return cb(err);
      return cb(null, entities);
    });
  });
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
Repository.prototype.getAll = function getAll (ids, cb) {
var self = this;

if (typeof ids === &#x27;function&#x27;) {
  cb = ids;
  ids = null;
  return this.events.distinct(&#x27;id&#x27;, function (err, distinctEventIds) {
    self.<span class="apidocCodeKeywordSpan">getAll</span>(distinctEventIds, cb);
  });
}

log(&#x27;getting %ss for ids %j&#x27;, this.entityType.name, ids);

if (ids.length === 0) return cb(null, []);
...</pre></li>
    </ul>


</div>

<div class="apidocFooterDiv">
    [ this document was created with
    <a href="https://github.com/kaizhu256/node-utility2" target="_blank">utility2</a>
    ]
</div>
</div>
